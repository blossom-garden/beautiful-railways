name: Export Modpack

on:
  workflow_dispatch:
    inputs:
      curseforge:
        type: boolean
        default: false
        description: Export Curseforge format?
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref || github.run_id }}
  cancel-in-progress: true

jobs:
  get-info:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, 'skip!')"
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine version number, pack name and last version number
        id: cat
        run: |
          echo $(cat ./pack.toml | grep "version = ") | sed -r 's/version = //' | sed -r 's/[" ]//g' | echo "version=$(< /dev/stdin)" >> "${GITHUB_OUTPUT}"
          echo $(cat ./pack.toml | grep "name = ") | sed -r 's/name = //' | sed -r 's/[" ]//g' | sed -r 's/([a-z0-9])([A-Z])/\1-\2/g' | tr '[:upper:]' '[:lower:]' | echo "name=$(< /dev/stdin)" >> "${GITHUB_OUTPUT}"
          echo "LASTTAG=$(git describe --tags --abbrev=0)" >> "${GITHUB_OUTPUT}"

    outputs:
      version: ${{ steps.cat.outputs.version }}
      name: ${{ steps.cat.outputs.name }}
      LASTTAG: ${{ steps.cat.outputs.LASTTAG }}

  build:
    needs:
      - get-info
    env:
      version: ${{ needs.get-info.outputs.version }}
      name: ${{ needs.get-info.outputs.name }}
    strategy:
      matrix:
        include:
          - platform: modrinth
            extension: .mrpack
            runner: ubuntu-latest

          - platform: curseforge
            extension: .zip
            runner: ubuntu-latest
    runs-on: ${{ matrix.runner }}
    permissions:
      contents: write
    defaults:
      run:
        shell: bash
    if: needs.get-info.outputs.LASTTAG != needs.get-info.outputs.version
    steps:
      - name: Prepare
        run: |
          rm -rfv build; mkdir -pv build
          echo "is_enabled=${{ (matrix.platform == 'modrinth') || (matrix.platform == 'curseforge' && inputs.curseforge == true) }}" >> ${{GITHUB_ENV}}

      - name: Checkout code
        if: env.is_enabled == true
        uses: actions/checkout@v4

      - name: Setup packwiz CLI
        if: env.is_enabled == true
        uses: vspr-sh/packwiz-setup-action@master

      - name: Export
        if: env.is_enabled == true
        run: packwiz ${{ matrix.platform }} export -o build/${{ env.name }}.${{ matrix.extension }}

      - name: Upload mr package to workflow artifacts
        if: env.is_enabled == true
        uses: actions/upload-artifact@v6
        with:
          path: build/${{ env.name }}.${{ matrix.extension }}
          name: ${{ env.name }}-${{ matrix.platform }}
          retention-days: 1

      - name: Upload package to GitHub release
        if: env.is_enabled == true
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: build/${{ env.name }}.${{ matrix.extension }}
          asset_name: ${{ env.name }}.${{ matrix.extension }}
          release_name: v${{ env.version }}
          tag: ${{ env.version }}
          overwrite: true
